# Maintainer: Your Name <your.email@example.com>
pkgname=goatdkernel
pkgver=0.1.0
pkgrel=1
pkgdesc="GOATd Kernel Builder - Pure Rust + egui UI for building and managing kernels"
arch=('x86_64')
url="https://github.com/MadGoatHaz/GOATd-Kernel"
license=('GPL-2.0+')
depends=('gcc-libs' 'glibc' 'openssl')
makedepends=('rust' 'cargo' 'git' 'pkgconf' 'base-devel')
optdepends=('modprobed-db: For modprobed-db integration support'
            'scx-scheds: For sched-ext kernel scheduler support'
            'polly: For LLVM vectorization support')
source=("${pkgname}::git+https://github.com/MadGoatHaz/GOATd-Kernel.git#tag=v${pkgver}")
md5sums=('SKIP')
options=('!lto')

prepare() {
    cd "${pkgname}"
    cargo fetch --locked --target x86_64-unknown-linux-gnu
}

build() {
    cd "${pkgname}"
    cargo build --frozen --release --all
}

package() {
    cd "${pkgname}"
    
    # Install binary
    install -Dm 755 target/release/goatd_kernel "${pkgdir}/usr/bin/goatd_kernel"
    
    # Install desktop entry
    install -Dm 644 assets/goatdkernel.desktop "${pkgdir}/usr/share/applications/goatdkernel.desktop"
    
    # Install icon
    install -Dm 644 assets/goatdkernel.svg "${pkgdir}/usr/share/pixmaps/goatdkernel.svg"
    
    # Install polkit policy
    install -Dm 644 assets/com.goatd.kernel.policy "${pkgdir}/usr/share/polkit-1/actions/com.goatd.kernel.policy"
    
    # Install documentation
    install -Dm 644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
}

# Post-install message
post_install() {
    echo "GOATd Kernel Builder has been installed!"
    echo "To run: goatd_kernel"
    echo ""
    echo "Optional dependencies for enhanced features:"
    echo "  - Install modprobed-db: yay -S modprobed-db"
    echo "  - Install scx-scheds: yay -S scx-scheds"
    echo "  - Install polly (from AUR): yay -S polly"
}

post_upgrade() {
    post_install
}
